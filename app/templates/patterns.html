{% extends "base.html" %}

{% block title %}Patterns - CryptoLens{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header & Filters -->
    <div class="flex items-center justify-between flex-wrap gap-4">
        <h1 class="text-2xl font-bold">Detected Patterns</h1>

        <form method="GET" class="flex items-center space-x-4">
            <select name="symbol" class="bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm">
                <option value="">All Symbols</option>
                {% for s in symbols %}
                <option value="{{ s.symbol }}" {% if current_symbol == s.symbol %}selected{% endif %}>
                    {{ s.symbol }}
                </option>
                {% endfor %}
            </select>

            <select name="timeframe" class="bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm">
                <option value="">All Timeframes</option>
                {% for tf in timeframes %}
                <option value="{{ tf }}" {% if current_timeframe == tf %}selected{% endif %}>{{ tf }}</option>
                {% endfor %}
            </select>

            <select name="status" class="bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm">
                <option value="active" {% if current_status == 'active' %}selected{% endif %}>Active</option>
                <option value="filled" {% if current_status == 'filled' %}selected{% endif %}>Filled</option>
                <option value="expired" {% if current_status == 'expired' %}selected{% endif %}>Expired</option>
                <option value="" {% if not current_status %}selected{% endif %}>All</option>
            </select>

            <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm">
                Filter
            </button>
        </form>
    </div>

    <!-- Chart Container -->
    {% if current_symbol %}
    <div class="bg-card rounded-lg p-4">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold">{{ current_symbol }} - {{ current_timeframe or '1h' }}</h2>
            <div class="flex space-x-2">
                {% for tf in timeframes %}
                <a href="?symbol={{ current_symbol }}&timeframe={{ tf }}&status={{ current_status }}"
                   class="px-3 py-1 rounded text-sm {% if current_timeframe == tf %}bg-blue-600{% else %}bg-gray-700 hover:bg-gray-600{% endif %}">
                    {{ tf }}
                </a>
                {% endfor %}
            </div>
        </div>
        <div id="chart" style="height: 400px;"></div>
    </div>
    {% endif %}

    <!-- Patterns List -->
    <div class="bg-card rounded-lg overflow-hidden">
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-700 bg-gray-800/50">
                    <th class="text-left p-3 text-muted font-medium">Symbol</th>
                    <th class="text-left p-3 text-muted font-medium">TF</th>
                    <th class="text-left p-3 text-muted font-medium">Detected</th>
                    <th class="text-left p-3 text-muted font-medium">Type</th>
                    <th class="text-left p-3 text-muted font-medium">Direction</th>
                    <th class="text-left p-3 text-muted font-medium">Zone</th>
                    <th class="text-left p-3 text-muted font-medium">Entry</th>
                    <th class="text-left p-3 text-muted font-medium">SL / TP</th>
                    <th class="text-left p-3 text-muted font-medium">Status</th>
                    <th class="text-left p-3 text-muted font-medium">Expires</th>
                </tr>
            </thead>
            <tbody>
                {% for pattern in patterns %}
                <tr class="border-b border-gray-800 hover:bg-gray-800/50 {% if pattern.is_expired %}opacity-60{% endif %}">
                    <td class="p-3">
                        <a href="?symbol={{ pattern.symbol.symbol }}&timeframe={{ pattern.timeframe }}"
                           class="hover:text-blue-400 font-medium">
                            {{ pattern.symbol.symbol }}
                        </a>
                    </td>
                    <td class="p-3 text-muted">{{ pattern.timeframe }}</td>
                    <td class="p-3 text-xs text-muted">
                        {{ pattern.detected_at_formatted }}
                    </td>
                    <td class="p-3">
                        {% if pattern.pattern_type == 'imbalance' %}
                            <span class="px-2 py-1 rounded text-xs bg-purple-900 text-purple-200">FVG</span>
                        {% elif pattern.pattern_type == 'order_block' %}
                            <span class="px-2 py-1 rounded text-xs bg-orange-900 text-orange-200">OB</span>
                        {% elif pattern.pattern_type == 'liquidity_sweep' %}
                            <span class="px-2 py-1 rounded text-xs bg-cyan-900 text-cyan-200">Sweep</span>
                        {% else %}
                            <span class="px-2 py-1 rounded text-xs bg-gray-700">{{ pattern.pattern_type }}</span>
                        {% endif %}
                    </td>
                    <td class="p-3">
                        <span class="{% if pattern.direction == 'bullish' %}bullish{% else %}bearish{% endif %} font-medium text-sm">
                            {% if pattern.direction == 'bullish' %}ðŸŸ¢{% else %}ðŸ”´{% endif %}
                        </span>
                    </td>
                    <td class="p-3 font-mono text-xs">
                        {% if pattern.zone_low < 0.01 %}
                            {{ '%.6f'|format(pattern.zone_low) }}-{{ '%.6f'|format(pattern.zone_high) }}
                        {% elif pattern.zone_low < 1 %}
                            {{ '%.4f'|format(pattern.zone_low) }}-{{ '%.4f'|format(pattern.zone_high) }}
                        {% elif pattern.zone_low < 100 %}
                            {{ '%.3f'|format(pattern.zone_low) }}-{{ '%.3f'|format(pattern.zone_high) }}
                        {% else %}
                            {{ '%.2f'|format(pattern.zone_low) }}-{{ '%.2f'|format(pattern.zone_high) }}
                        {% endif %}
                    </td>
                    <td class="p-3 font-mono text-xs {% if pattern.direction == 'bullish' %}text-green-400{% else %}text-red-400{% endif %}">
                        {% set entry = pattern.trading_levels.entry %}
                        {% if entry < 0.01 %}{{ '%.6f'|format(entry) }}
                        {% elif entry < 1 %}{{ '%.4f'|format(entry) }}
                        {% elif entry < 100 %}{{ '%.3f'|format(entry) }}
                        {% else %}{{ '%.2f'|format(entry) }}{% endif %}
                    </td>
                    <td class="p-3 font-mono text-xs">
                        {% set sl = pattern.trading_levels.stop_loss %}
                        {% set tp = pattern.trading_levels.take_profit_2 %}
                        <span class="text-red-500">{% if sl < 1 %}{{ '%.4f'|format(sl) }}{% else %}{{ '%.2f'|format(sl) }}{% endif %}</span>
                        <span class="text-muted">/</span>
                        <span class="text-green-500">{% if tp < 1 %}{{ '%.4f'|format(tp) }}{% else %}{{ '%.2f'|format(tp) }}{% endif %}</span>
                        <span class="text-muted">({{ pattern.trading_levels.risk_reward_2 }}R)</span>
                    </td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded text-xs
                            {% if pattern.status == 'active' and not pattern.is_expired %}bg-blue-900 text-blue-200
                            {% elif pattern.status == 'filled' %}bg-green-900 text-green-200
                            {% elif pattern.status == 'expired' or pattern.is_expired %}bg-gray-700 text-gray-400
                            {% else %}bg-gray-700{% endif %}">
                            {% if pattern.is_expired and pattern.status == 'active' %}expired{% else %}{{ pattern.status }}{% endif %}
                        </span>
                        {% if pattern.fill_percentage and pattern.fill_percentage > 0 %}
                        <span class="text-xs text-muted ml-1">{{ '%.0f'|format(pattern.fill_percentage) }}%</span>
                        {% endif %}
                    </td>
                    <td class="p-3 text-xs">
                        {% if pattern.status == 'active' and not pattern.is_expired %}
                            <span class="{% if pattern.time_remaining.startswith('0h') or pattern.time_remaining.startswith('1h') %}text-red-400{% elif 'h' in pattern.time_remaining and pattern.time_remaining.split('h')[0]|int < 6 %}text-yellow-400{% else %}text-muted{% endif %}">
                                {{ pattern.time_remaining }}
                            </span>
                        {% elif pattern.is_expired %}
                            <span class="text-gray-500">Expired</span>
                        {% else %}
                            <span class="text-gray-500">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="10" class="p-8 text-center text-muted">
                        No patterns found. Run a scan to detect patterns.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if current_symbol %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    const chartContainer = document.getElementById('chart');
    const chart = LightweightCharts.createChart(chartContainer, {
        layout: {
            background: { color: '#242424' },
            textColor: '#DDD',
        },
        grid: {
            vertLines: { color: '#333' },
            horzLines: { color: '#333' },
        },
        width: chartContainer.clientWidth,
        height: 400,
    });

    const candlestickSeries = chart.addCandlestickSeries({
        upColor: '#22c55e',
        downColor: '#ef4444',
        borderUpColor: '#22c55e',
        borderDownColor: '#ef4444',
        wickUpColor: '#22c55e',
        wickDownColor: '#ef4444',
    });

    // Fetch chart data
    const symbol = '{{ current_symbol }}'.replace('/', '-');
    const timeframe = '{{ current_timeframe or "1h" }}';

    try {
        const response = await fetch(`/patterns/chart/${symbol}/${timeframe}`);
        const data = await response.json();

        if (data.candles) {
            const candles = data.candles.map(c => ({
                time: c.timestamp / 1000,
                open: c.open,
                high: c.high,
                low: c.low,
                close: c.close,
            }));
            candlestickSeries.setData(candles);

            // Draw pattern zones
            data.patterns.forEach(pattern => {
                const color = pattern.direction === 'bullish'
                    ? 'rgba(34, 197, 94, 0.3)'
                    : 'rgba(239, 68, 68, 0.3)';

                // Add horizontal lines for zone
                candlestickSeries.createPriceLine({
                    price: pattern.zone_high,
                    color: pattern.direction === 'bullish' ? '#22c55e' : '#ef4444',
                    lineWidth: 1,
                    lineStyle: 2,
                    axisLabelVisible: true,
                    title: pattern.direction === 'bullish' ? 'FVG High' : 'FVG High',
                });
                candlestickSeries.createPriceLine({
                    price: pattern.zone_low,
                    color: pattern.direction === 'bullish' ? '#22c55e' : '#ef4444',
                    lineWidth: 1,
                    lineStyle: 2,
                    axisLabelVisible: true,
                    title: pattern.direction === 'bullish' ? 'FVG Low' : 'FVG Low',
                });
            });
        }

        chart.timeScale().fitContent();
    } catch (e) {
        console.error('Failed to load chart data:', e);
    }

    // Resize handler
    window.addEventListener('resize', () => {
        chart.applyOptions({ width: chartContainer.clientWidth });
    });
});
</script>
{% endif %}
{% endblock %}
