{% extends "base.html" %}

{% block title %}Upgrade - CryptoLens{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="text-center mb-12">
        <h1 class="text-4xl font-bold mb-4">Upgrade Your Plan</h1>
        <p class="text-xl text-gray-400">Get more from CryptoLens with premium features</p>
    </div>

    <!-- Billing Toggle -->
    <div class="flex justify-center mb-8">
        <div class="bg-card rounded-lg p-1 inline-flex">
            <button type="button" id="btn-monthly" onclick="setBilling('monthly')"
                    class="px-6 py-2 rounded-md transition billing-btn active">
                Monthly
            </button>
            <button type="button" id="btn-yearly" onclick="setBilling('yearly')"
                    class="px-6 py-2 rounded-md transition billing-btn">
                Yearly <span class="text-green-400 text-sm">(Save 17%)</span>
            </button>
        </div>
    </div>

    <!-- Pricing Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        {% for plan_key, plan in plans.items() %}
        {% set is_pro = plan_key == 'pro' %}
        {% set is_premium = plan_key == 'premium' %}
        {% set is_free = plan_key == 'free' %}

        <div class="bg-card rounded-xl p-8 {% if is_pro %}relative{% endif %} {% if current_plan == plan_key %}ring-2 ring-blue-500{% endif %}">
            {% if is_pro %}
            <div class="absolute -top-4 left-1/2 transform -translate-x-1/2">
                <span class="bg-blue-600 text-white px-4 py-1 rounded-full text-sm font-medium">Popular</span>
            </div>
            {% endif %}

            <div class="text-center mb-6">
                <h3 class="text-2xl font-bold">{{ plan.name }}</h3>
                <p class="text-sm text-gray-400 mt-1">{{ plan.tagline }}</p>
                <div class="mt-4">
                    <span class="text-4xl font-bold {% if is_pro %}text-blue-400{% elif is_premium %}text-purple-400{% endif %}" {% if not is_free %}id="{{ plan_key }}-price"{% endif %}>${{ plan.price }}</span>
                    <span class="text-gray-400" {% if not is_free %}id="{{ plan_key }}-period"{% endif %}>{% if is_free %}/forever{% else %}/month{% endif %}</span>
                </div>
            </div>

            <ul class="space-y-3 mb-8">
                {% for feature in plan.features %}
                <li class="flex items-center {% if not feature.included %}text-gray-500{% endif %}">
                    {% if feature.included %}
                    <svg class="w-5 h-5 {% if is_pro %}text-blue-400{% elif is_premium %}text-purple-400{% else %}text-green-400{% endif %} mr-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                    {% else %}
                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    {% endif %}
                    {% if feature.highlight %}<strong>{{ feature.highlight }}</strong>{{ feature.text|replace(feature.highlight, '') }}{% else %}{{ feature.text }}{% endif %}
                </li>
                {% endfor %}
            </ul>

            {% if current_plan == plan_key %}
            <button disabled class="w-full py-3 bg-gray-700 text-gray-400 rounded-lg cursor-not-allowed">
                Current Plan
            </button>
            {% elif is_free %}
            <button disabled class="w-full py-3 bg-gray-700 text-gray-400 rounded-lg cursor-not-allowed">
                Downgrade Not Available
            </button>
            {% elif is_pro %}
            <button onclick="showCheckout('pro')"
                    class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition">
                Upgrade to Pro
            </button>
            {% elif is_premium %}
            <button onclick="showCheckout('premium')"
                    class="w-full py-3 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white font-bold rounded-lg transition">
                Upgrade to Premium
            </button>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Payment History Link -->
    <div class="mt-12 text-center">
        <a href="{{ url_for('payments.payment_history') }}" class="text-gray-400 hover:text-gray-300">
            View Payment History
        </a>
    </div>
</div>

<!-- Checkout Modal -->
<div id="checkout-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-card rounded-xl p-8 max-w-md w-full mx-4">
        <h2 class="text-2xl font-bold mb-6">Complete Your Purchase</h2>

        <form method="POST" action="{{ url_for('payments.checkout') }}" id="checkout-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="plan" id="checkout-plan" value="">
            <input type="hidden" name="billing_cycle" id="checkout-billing" value="monthly">

            <!-- Plan Summary -->
            <div class="bg-darker rounded-lg p-4 mb-6">
                <div class="flex justify-between items-center">
                    <span id="checkout-plan-name" class="font-medium">Pro</span>
                    <span id="checkout-price" class="text-xl font-bold">$9.99/mo</span>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-300 mb-3">Payment Method</label>
                <div class="space-y-3">
                    {% if lemonsqueezy_enabled %}
                    <label class="flex items-center p-3 bg-darker rounded-lg cursor-pointer border-2 border-transparent has-[:checked]:border-blue-500">
                        <input type="radio" name="payment_method" value="card" class="sr-only" checked>
                        <div class="flex items-center flex-1">
                            <svg class="w-8 h-8 mr-3" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>
                            <span>Card (Visa, Mastercard, etc.)</span>
                        </div>
                        <span class="w-4 h-4 rounded-full border-2 border-blue-500 flex items-center justify-center">
                            <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                        </span>
                    </label>
                    {% endif %}

                    {% if nowpayments_enabled %}
                    <label class="flex items-center p-3 bg-darker rounded-lg cursor-pointer border-2 border-transparent has-[:checked]:border-blue-500">
                        <input type="radio" name="payment_method" value="crypto" class="sr-only" onchange="toggleCryptoSelect(true)">
                        <div class="flex items-center flex-1">
                            <svg class="w-8 h-8 mr-3" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                            <span>Cryptocurrency</span>
                        </div>
                        <span class="w-4 h-4 rounded-full border-2 border-gray-600"></span>
                    </label>

                    <!-- Crypto Currency Select -->
                    <div id="crypto-select" class="hidden pl-11">
                        <select name="crypto_currency" class="w-full px-4 py-2 bg-darker border border-gray-700 rounded-lg focus:outline-none focus:border-blue-500 text-white">
                            {% for crypto in available_cryptos %}
                            <option value="{{ crypto }}" {% if crypto == 'USDT' %}selected{% endif %}>{{ crypto }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    {% if not lemonsqueezy_enabled and not nowpayments_enabled %}
                    <p class="text-gray-400 text-center py-4">
                        Payment processing is not configured. Please contact support.
                    </p>
                    {% endif %}
                </div>
            </div>

            <!-- Actions -->
            <div class="flex space-x-4">
                <button type="button" onclick="hideCheckout()"
                        class="flex-1 py-3 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg transition">
                    Cancel
                </button>
                {% if lemonsqueezy_enabled or nowpayments_enabled %}
                <button type="submit"
                        class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition">
                    Continue
                </button>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<style>
.billing-btn {
    color: #9ca3af;
}
.billing-btn.active {
    background-color: #3b82f6;
    color: white;
}
</style>

<script>
const plans = {
    pro: { monthly: {{ plans.pro.price }}, yearly: {{ plans.pro.price_yearly }} },
    premium: { monthly: {{ plans.premium.price }}, yearly: {{ plans.premium.price_yearly }} }
};

let currentBilling = 'monthly';
let currentPlan = 'pro';

function setBilling(billing) {
    currentBilling = billing;

    // Update toggle buttons
    document.querySelectorAll('.billing-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('btn-' + billing).classList.add('active');

    // Update prices
    if (billing === 'yearly') {
        document.getElementById('pro-price').textContent = '$' + plans.pro.yearly;
        document.getElementById('pro-period').textContent = '/year';
        document.getElementById('premium-price').textContent = '$' + plans.premium.yearly;
        document.getElementById('premium-period').textContent = '/year';
    } else {
        document.getElementById('pro-price').textContent = '$' + plans.pro.monthly;
        document.getElementById('pro-period').textContent = '/month';
        document.getElementById('premium-price').textContent = '$' + plans.premium.monthly;
        document.getElementById('premium-period').textContent = '/month';
    }

    // Update checkout form if open
    document.getElementById('checkout-billing').value = billing;
    updateCheckoutPrice();
}

function showCheckout(plan) {
    currentPlan = plan;
    document.getElementById('checkout-plan').value = plan;
    document.getElementById('checkout-billing').value = currentBilling;
    document.getElementById('checkout-plan-name').textContent = plan.charAt(0).toUpperCase() + plan.slice(1);
    updateCheckoutPrice();
    document.getElementById('checkout-modal').classList.remove('hidden');
}

function hideCheckout() {
    document.getElementById('checkout-modal').classList.add('hidden');
}

function updateCheckoutPrice() {
    const price = plans[currentPlan][currentBilling];
    const period = currentBilling === 'yearly' ? '/yr' : '/mo';
    document.getElementById('checkout-price').textContent = '$' + price + period;
}

function toggleCryptoSelect(show) {
    const cryptoSelect = document.getElementById('crypto-select');
    if (show) {
        cryptoSelect.classList.remove('hidden');
    } else {
        cryptoSelect.classList.add('hidden');
    }
}

// Handle payment method radio changes
document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
    radio.addEventListener('change', function() {
        toggleCryptoSelect(this.value === 'crypto');
        // Update visual selection
        document.querySelectorAll('input[name="payment_method"]').forEach(r => {
            const label = r.closest('label');
            const indicator = label.querySelector('span:last-child');
            if (r.checked) {
                label.classList.add('border-blue-500');
                indicator.innerHTML = '<span class="w-2 h-2 rounded-full bg-blue-500"></span>';
                indicator.classList.add('border-blue-500');
            } else {
                label.classList.remove('border-blue-500');
                indicator.innerHTML = '';
                indicator.classList.remove('border-blue-500');
                indicator.classList.add('border-gray-600');
            }
        });
    });
});

// Close modal on escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideCheckout();
    }
});
</script>
{% endblock %}
