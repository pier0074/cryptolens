{% extends "base.html" %}

{% block title %}Logs - CryptoLens{% endblock %}

{% block extra_css %}
<style>
    .log-row { font-family: monospace; font-size: 0.85rem; }
    .log-DEBUG { color: #888; }
    .log-INFO { color: #60a5fa; }
    .log-WARNING { color: #fbbf24; }
    .log-ERROR { color: #ef4444; }

    .category-fetch { border-left: 3px solid #22c55e; }
    .category-aggregate { border-left: 3px solid #3b82f6; }
    .category-scan { border-left: 3px solid #a855f7; }
    .category-signal { border-left: 3px solid #f59e0b; }
    .category-notify { border-left: 3px solid #06b6d4; }
    .category-system { border-left: 3px solid #6b7280; }
    .category-error { border-left: 3px solid #ef4444; }
</style>
{% endblock %}

{% block content %}
<div x-data="logsApp()" x-init="loadLogs()">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">System Logs</h1>
        <div class="flex items-center space-x-4">
            <button @click="loadLogs()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-md text-sm">
                Refresh
            </button>
            <label class="flex items-center space-x-2">
                <input type="checkbox" x-model="autoRefresh" @change="toggleAutoRefresh()" class="rounded">
                <span class="text-sm">Auto-refresh</span>
            </label>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-card p-4 rounded-lg">
            <div class="text-muted text-sm">Last Hour</div>
            <div class="text-2xl font-bold" x-text="stats.last_hour || 0"></div>
        </div>
        <div class="bg-card p-4 rounded-lg">
            <div class="text-muted text-sm">Last 24h</div>
            <div class="text-2xl font-bold" x-text="stats.last_day || 0"></div>
        </div>
        <div class="bg-card p-4 rounded-lg">
            <div class="text-muted text-sm">Total Logs</div>
            <div class="text-2xl font-bold" x-text="stats.total || 0"></div>
        </div>
        <div class="bg-card p-4 rounded-lg">
            <div class="text-muted text-sm">Errors Today</div>
            <div class="text-2xl font-bold text-red-500" x-text="stats.errors_today || 0"></div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-card p-4 rounded-lg mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm text-muted mb-1">Category</label>
                <select x-model="filters.category" @change="loadLogs()" class="w-full bg-darker border border-gray-700 rounded px-3 py-2 text-white">
                    <option value="">All Categories</option>
                    {% for key, label in categories.items() %}
                    <option value="{{ key }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm text-muted mb-1">Level</label>
                <select x-model="filters.level" @change="loadLogs()" class="w-full bg-darker border border-gray-700 rounded px-3 py-2 text-white">
                    <option value="">All Levels</option>
                    {% for level in levels %}
                    <option value="{{ level }}">{{ level }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm text-muted mb-1">Symbol</label>
                <select x-model="filters.symbol" @change="loadLogs()" class="w-full bg-darker border border-gray-700 rounded px-3 py-2 text-white">
                    <option value="">All Symbols</option>
                    {% for symbol in symbols %}
                    <option value="{{ symbol.symbol }}">{{ symbol.symbol }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm text-muted mb-1">Limit</label>
                <select x-model="filters.limit" @change="loadLogs()" class="w-full bg-darker border border-gray-700 rounded px-3 py-2 text-white">
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Category Legend -->
    <div class="flex flex-wrap gap-4 mb-4 text-sm">
        <span class="flex items-center"><span class="w-3 h-3 bg-green-500 rounded mr-2"></span>Fetch</span>
        <span class="flex items-center"><span class="w-3 h-3 bg-blue-500 rounded mr-2"></span>Aggregate</span>
        <span class="flex items-center"><span class="w-3 h-3 bg-purple-500 rounded mr-2"></span>Scan</span>
        <span class="flex items-center"><span class="w-3 h-3 bg-yellow-500 rounded mr-2"></span>Signal</span>
        <span class="flex items-center"><span class="w-3 h-3 bg-cyan-500 rounded mr-2"></span>Notify</span>
        <span class="flex items-center"><span class="w-3 h-3 bg-gray-500 rounded mr-2"></span>System</span>
        <span class="flex items-center"><span class="w-3 h-3 bg-red-500 rounded mr-2"></span>Error</span>
    </div>

    <!-- Logs Table -->
    <div class="bg-card rounded-lg overflow-hidden">
        <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
            <table class="w-full">
                <thead class="bg-darker sticky top-0">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-muted uppercase">Time</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-muted uppercase">Category</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-muted uppercase">Level</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-muted uppercase">Symbol</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-muted uppercase">Message</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="log in logs" :key="log.id">
                        <tr class="border-t border-gray-800 hover:bg-darker log-row" :class="'category-' + log.category">
                            <td class="px-4 py-2 whitespace-nowrap text-muted" x-text="formatTime(log.timestamp)"></td>
                            <td class="px-4 py-2 whitespace-nowrap">
                                <span class="px-2 py-1 rounded text-xs"
                                      :class="{
                                          'bg-green-900 text-green-300': log.category === 'fetch',
                                          'bg-blue-900 text-blue-300': log.category === 'aggregate',
                                          'bg-purple-900 text-purple-300': log.category === 'scan',
                                          'bg-yellow-900 text-yellow-300': log.category === 'signal',
                                          'bg-cyan-900 text-cyan-300': log.category === 'notify',
                                          'bg-gray-700 text-gray-300': log.category === 'system',
                                          'bg-red-900 text-red-300': log.category === 'error'
                                      }"
                                      x-text="log.category"></span>
                            </td>
                            <td class="px-4 py-2 whitespace-nowrap" :class="'log-' + log.level" x-text="log.level"></td>
                            <td class="px-4 py-2 whitespace-nowrap" x-text="log.symbol || '-'"></td>
                            <td class="px-4 py-2" x-text="log.message"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div x-show="logs.length === 0" class="p-8 text-center text-muted">
            No logs found matching your filters
        </div>
    </div>

    <!-- Load More -->
    <div class="mt-4 text-center" x-show="logs.length >= filters.limit">
        <button @click="loadMore()" class="bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded-md text-sm">
            Load More
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function logsApp() {
    return {
        logs: [],
        stats: {},
        filters: {
            category: '{{ current_category }}',
            level: '{{ current_level }}',
            symbol: '{{ current_symbol }}',
            limit: 100
        },
        autoRefresh: false,
        refreshInterval: null,

        async loadLogs() {
            const params = new URLSearchParams({
                category: this.filters.category,
                level: this.filters.level,
                symbol: this.filters.symbol,
                limit: this.filters.limit,
                offset: 0
            });

            try {
                const [logsRes, statsRes] = await Promise.all([
                    fetch('/logs/api/logs?' + params),
                    fetch('/logs/api/stats')
                ]);

                const logsData = await logsRes.json();
                const statsData = await statsRes.json();

                this.logs = logsData.logs;
                this.stats = statsData;
            } catch (e) {
                console.error('Failed to load logs:', e);
            }
        },

        async loadMore() {
            const params = new URLSearchParams({
                category: this.filters.category,
                level: this.filters.level,
                symbol: this.filters.symbol,
                limit: this.filters.limit,
                offset: this.logs.length
            });

            try {
                const res = await fetch('/logs/api/logs?' + params);
                const data = await res.json();
                this.logs = [...this.logs, ...data.logs];
            } catch (e) {
                console.error('Failed to load more logs:', e);
            }
        },

        formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }) + ' ' + date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
        },

        toggleAutoRefresh() {
            if (this.autoRefresh) {
                this.refreshInterval = setInterval(() => this.loadLogs(), 5000);
            } else {
                clearInterval(this.refreshInterval);
            }
        }
    }
}
</script>
{% endblock %}
